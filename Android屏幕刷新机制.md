---
title: Android屏幕刷新机制
---

# 显示系统基础知识

在一个典型的显示系统中，一般包括CPU、GPU、Display三个部分，CPU负责计算帧数据，把计算好的数据交给GPU，GPU会对数据进行渲染，渲染好后放到buffer（图像缓冲区）存起来，然后Display（屏幕或显示器）负责把buffer的数据呈现到屏幕上。

# 基础概念

- 屏幕刷新频率

  一秒内屏幕刷新的次数（一秒内显示了多少帧的图像），单位是Hz；刷新频率取决于硬件的固定参数

- 逐行扫描

  显示器并不是一次性将画面显示到屏幕上，而是从左到右，从上到下逐行扫描，顺序显示整屏的一个个像素点。

- 帧率（Frame Rate）

  表示GPU在一秒内绘制操作的帧数，单位是fps。Android系统采用60fps，即每秒钟GPU最多绘制60帧画面。

- 画面撕裂（tearing）

  一个屏幕内的数据来自2个不同的帧，画面会出现撕裂感。

# 双缓存

## 原因

屏幕刷新频率是固定的，比如每16.6ms从buffer取数据显示完一帧，理想情况下帧率和刷新频率保持一致，即每绘制完成一帧，显示器显示一帧，但是CPU/GPU写数据是不可控的，所以会出现buffer里有些数据根本没显示出来就被重写了，即buffer里的数据可能是来自不同的帧。当屏幕刷新时，此时它并不知道buffer的状态，因此从buffer抓取的帧并不是完整的一帧画面，即出现画面撕裂。

## 解决：双缓存

让绘制和显示拥有各自的buffer：GPU始终将完成的一帧图像数据写入到**Back Buffer**，而显示器使用**Frame Buffer**，当屏幕刷新时，Frame Buffer并不会发生变化，当Back buffer准备就绪后，它们才进行交换。

## 交换时机：VSync

时机：等到屏幕处理完一帧数据后，才进行交换。

当扫描完一个屏幕后，设备需要重新回到第一行以进入下一次的循环，此时有一段时间空隙，称为Vertical Blanking Interval(VBI)。这个时间点就是我们进行缓冲区交换的最佳时间。因为此时屏幕没有在刷新，也就避免了交换过程中出现screen tearing的状况。

**VSyc**（垂直同步）是Vertical Synchronization的简写，它利用VBI时期出现的vertical sync pulse（垂直同步脉冲）来保证双缓冲在最佳时间点才进行交换。另外，交换是指各自的内存地址。

# Android屏幕刷新机制

## Android 4.1之前：双缓存 + VSync

![](https://img-blog.csdnimg.cn/20200819205135422.png#pic_center)

1. Display显示第0帧数据，此时CPU和GPU渲染第1帧画面，且在Display显示下一帧前完成
2. 